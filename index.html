<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>EZVIZ Live</title>
  <style>
    body {
      margin: 0;
      background: black;
      color: white;
      font-family: Arial, sans-serif;
    }
    #container {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    #video {
      flex: 1;
      background: black;
    }
    #controls {
      padding: 15px;
      background: #222;
      border-top: 1px solid #444;
    }
    .control-group {
      margin-bottom: 10px;
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    input[type="text"] {
      padding: 8px;
      border: 1px solid #444;
      border-radius: 4px;
      background: #333;
      color: white;
      min-width: 150px;
    }
    button {
      padding: 8px 16px;
      background: #0066cc;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    button:hover {
      background: #0052a3;
    }
    button:disabled {
      background: #666;
      cursor: not-allowed;
    }
    #status {
      font-size: 12px;
      color: #aaa;
    }
    .error {
      color: #ff6b6b;
    }
    .success {
      color: #51cf66;
    }
  </style>
</head>
<body>
<div id="container">
  <video id="video" autoplay playsinline muted></video>
  <div id="controls">
    <div class="control-group">
      <label>Camera IP:</label>
      <input type="text" id="cameraIp" placeholder="e.g., 192.168.1.4" value="192.168.1.4">
      <label>Server IP:</label>
      <input type="text" id="serverIp" placeholder="e.g., 192.168.1.6" value="192.168.1.6">
      <button onclick="startStream()">â–¶ Connect</button>
    </div>
    <div id="status">Ready</div>
  </div>
</div>

<script>
// Configuration constants
const CONFIG = {
  DISCOVERY_SERVER: 'http://localhost:3000',
  MEDIAMTX_PORT: 8889,
  STUN_SERVER: 'stun:stun.l.google.com:19302'
};

let pc = null;
let scannedCameras = [];

// Get server IP and scan for cameras in parallel on page load
async function initializeMediaMTX() {
  try {
    setStatus('â³ Initializing system...', 'info');
    
    // Get server IP and scan for cameras in parallel (no MediaMTX start yet)
    console.log('ðŸŒ Detecting server IP and scanning for cameras...');
    
    const serverIpPromise = fetch(`${CONFIG.DISCOVERY_SERVER}/getServerIp`)
      .then(r => r.json());
    
    const scanPromise = fetch(`${CONFIG.DISCOVERY_SERVER}/scan`)
      .then(r => r.json());
    
    // Wait for both to complete
    const [ipData, scanData] = await Promise.all([serverIpPromise, scanPromise]);
    
    // Set server IP
    if (ipData.serverIp) {
      document.getElementById('serverIp').value = ipData.serverIp;
      console.log('âœ… Server IP detected:', ipData.serverIp);
    }
    
    // Check if cameras were found
    if (!scanData.cameras || scanData.cameras.length === 0) {
      setStatus('âš ï¸ No cameras found. Please scan manually or configure camera IP.', 'warning');
      console.log('No cameras found in scan');
      return;
    }
    
    console.log('ðŸ“¹ Found cameras:', scanData.cameras);
    scannedCameras = scanData.cameras;
    
    // Get the first camera and auto-start stream with it
    const firstCamera = scanData.cameras[0];
    console.log(`ðŸŽ¯ Auto-selecting first camera: ${firstCamera}`);
    document.getElementById('cameraIp').value = firstCamera;
    
    // Now configure camera and start MediaMTX only once
    await configureAndStartMediaMTX(firstCamera);
    
  } catch (error) {
    console.error('Error initializing system:', error);
    setStatus(`âš ï¸ Initialization error: ${error.message}`, 'warning');
  }
}

// Configure camera IP and start MediaMTX only once
async function configureAndStartMediaMTX(cameraIp) {
  try {
    setStatus(`â³ Configuring camera at ${cameraIp}...`, 'info');
    
    // Configure the camera IP in mediamtx.yml
    const configResponse = await fetch(
      `${CONFIG.DISCOVERY_SERVER}/configure?cameraIp=${cameraIp}`,
      { method: 'POST' }
    );
    const configData = await configResponse.json();
    
    if (configData.status !== 'success') {
      throw new Error(configData.error || 'Failed to configure camera');
    }
    
    console.log('âœ… Camera configured:', configData);
    
    // Now start MediaMTX ONCE with the correct camera configuration
    setStatus('â³ Starting MediaMTX with configured camera...', 'info');
    const startResponse = await fetch(`${CONFIG.DISCOVERY_SERVER}/start`, { method: 'POST' });
    const startData = await startResponse.json();
    
    if (startData.status === 'success' || startData.status === 'already_running') {
      console.log('âœ… MediaMTX started with correct camera configuration');
      setStatus('âœ… Ready to stream', 'success');
      
      // Wait a moment for MediaMTX to fully initialize
      await new Promise(resolve => setTimeout(resolve, 2000));
      
      // Auto-start stream
      console.log('ðŸŽ¬ Auto-starting stream...');
      setStatus('ðŸ”„ Connecting to stream...', 'info');
      await startStream();
      
    } else {
      throw new Error(startData.error || 'Failed to start MediaMTX');
    }
  } catch (error) {
    console.error('Error configuring and starting MediaMTX:', error);
    setStatus(`âŒ Error: ${error.message}`, 'error');
  }
}



// Stop MediaMTX when page unloads
async function shutdownMediaMTX() {
  try {
    console.log('Stopping MediaMTX...');
    await fetch(`${CONFIG.DISCOVERY_SERVER}/stop`, { method: 'POST', keepalive: true });
  } catch (error) {
    console.error('Error stopping MediaMTX:', error);
  }
}

// Load saved config on page load
function loadConfig() {
  const savedCameraIp = localStorage.getItem('cameraIp');
  const savedServerIp = localStorage.getItem('serverIp');
  
  if (savedCameraIp) {
    document.getElementById('cameraIp').value = savedCameraIp;
  }
  if (savedServerIp) {
    document.getElementById('serverIp').value = savedServerIp;
  }
}

// Save configuration
function saveConfig() {
  localStorage.setItem('cameraIp', document.getElementById('cameraIp').value);
  localStorage.setItem('serverIp', document.getElementById('serverIp').value);
}

// Update status message
function setStatus(message, type = 'info') {
  const statusDiv = document.getElementById('status');
  statusDiv.textContent = message;
  statusDiv.className = type;
}


// Start WebRTC stream
async function startStream() {
  const serverIp = document.getElementById('serverIp').value.trim();
  const streamPath = 'ezviz'; // Fixed path for EZVIZ camera
  
  if (!serverIp) {
    setStatus('âŒ Server IP is required', 'error');
    return;
  }
  
  // Save for next time
  saveConfig();
  
  const WHEP_ENDPOINT = `http://${serverIp}:${CONFIG.MEDIAMTX_PORT}/${streamPath}/whep`;
  
  try {
    setStatus('â³ Connecting to ' + serverIp + '...', 'info');
    
    // Close previous connection
    if (pc) {
      pc.close();
    }
    
    // Create new peer connection
    pc = new RTCPeerConnection({
      iceServers: [{ urls: [CONFIG.STUN_SERVER] }]
    });
    
    const video = document.getElementById('video');
    
    // Add video transceiver
    pc.addTransceiver('video', { direction: 'recvonly' });
    
    // Handle incoming video track
    pc.ontrack = (event) => {
      console.log('ðŸ“¹ Track received:', event.track.kind);
      video.srcObject = event.streams[0];
      setStatus('ðŸŸ¢ Connected - Streaming', 'success');
    };
    
    // Handle connection state changes
    pc.onconnectionstatechange = () => {
      console.log('Connection state:', pc.connectionState);
      switch (pc.connectionState) {
        case 'failed':
        case 'disconnected':
          setStatus('ðŸ”´ Connection lost', 'error');
          break;
        case 'closed':
          setStatus('Connection closed', 'warning');
          break;
      }
    };
    
    // Handle ICE candidates
    pc.onicecandidate = (event) => {
      if (event.candidate) {
        console.log('ðŸ§Š ICE candidate:', event.candidate.candidate);
      }
    };

    // Create and send offer
    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    
    console.log('ðŸ“¤ Sending offer to', WHEP_ENDPOINT);
    
    const res = await fetch(WHEP_ENDPOINT, {
      method: 'POST',
      headers: { 'Content-Type': 'application/sdp' },
      body: offer.sdp
    });

    if (!res.ok) {
      const errorText = await res.text();
      console.error('Server error:', errorText);
      throw new Error(`Server error: ${res.status} - ${errorText}`);
    }

    // Receive and set answer
    const answerSdp = await res.text();
    console.log('ðŸ“¥ Received answer');
    
    const answer = new RTCSessionDescription({
      type: 'answer',
      sdp: answerSdp
    });
    
    await pc.setRemoteDescription(answer);
    console.log('âœ… WebRTC connection established');
    
  } catch (error) {
    console.error('âŒ Error:', error);
    setStatus('âŒ Error: ' + error.message, 'error');
  }
}

// Load saved config on page load
window.addEventListener('load', () => {
  loadConfig();
  initializeMediaMTX();
});

// Stop MediaMTX when page unloads
window.addEventListener('beforeunload', shutdownMediaMTX);
window.addEventListener('unload', shutdownMediaMTX);

// Allow Enter key to start stream
document.addEventListener('keypress', (e) => {
  if (e.key === 'Enter') {
    startStream();
  }
});
</script>
</body>
</html>
