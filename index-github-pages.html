<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>EZVIZ Live Stream</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      background: #000;
      color: #fff;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    
    #container {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    
    #video {
      flex: 1;
      width: 100%;
      background: #000;
    }
    
    #controls {
      padding: 15px 20px;
      background: #1a1a1a;
      border-top: 1px solid #333;
    }
    
    .control-group {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }
    
    .control-group label {
      min-width: 100px;
      font-size: 14px;
      font-weight: 500;
    }
    
    input[type="text"] {
      padding: 8px 12px;
      border: 1px solid #444;
      border-radius: 4px;
      background: #2a2a2a;
      color: #fff;
      font-size: 14px;
      min-width: 160px;
    }
    
    input[type="text"]:focus {
      outline: none;
      border-color: #0066cc;
      background: #333;
    }
    
    button {
      padding: 8px 16px;
      background: #0066cc;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: background 0.2s;
    }
    
    button:hover {
      background: #0052a3;
    }
    
    button:disabled {
      background: #666;
      cursor: not-allowed;
    }
    
    #status {
      font-size: 12px;
      margin-top: 8px;
      padding: 8px 0;
      min-height: 18px;
    }
    
    #status.info {
      color: #999;
    }
    
    #status.success {
      color: #51cf66;
    }
    
    #status.error {
      color: #ff6b6b;
    }
    
    #status.warning {
      color: #ffd93d;
    }
  </style>
</head>
<body>
<div id="container">
  <video id="video" autoplay playsinline muted></video>
  
  <div id="controls">
    <div class="control-group">
      <label>Server IP:</label>
      <input type="text" id="serverIp" placeholder="e.g., 192.168.1.6" value="192.168.1.6">
      <label>Stream Path:</label>
      <input type="text" id="streamPath" placeholder="e.g., ezviz" value="ezviz" style="min-width: 100px;">
      <button onclick="startStream()">â–¶ Connect</button>
    </div>
    
    <div id="status" class="info">Ready. Enter server IP and click Connect.</div>
  </div>
</div>

<script>
// Configuration
const CONFIG = {
  MEDIAMTX_PORT: 8889,
  STUN_SERVER: 'stun:stun.l.google.com:19302'
};

let pc = null;

// Load saved configuration
function loadConfig() {
  const savedServerIp = localStorage.getItem('serverIp');
  const savedStreamPath = localStorage.getItem('streamPath');
  
  if (savedServerIp) {
    document.getElementById('serverIp').value = savedServerIp;
  }
  if (savedStreamPath) {
    document.getElementById('streamPath').value = savedStreamPath;
  }
}

// Save configuration
function saveConfig() {
  localStorage.setItem('serverIp', document.getElementById('serverIp').value);
  localStorage.setItem('streamPath', document.getElementById('streamPath').value);
}

// Update status message
function setStatus(message, type = 'info') {
  const statusDiv = document.getElementById('status');
  statusDiv.textContent = message;
  statusDiv.className = type;
}

// Start WebRTC stream
async function startStream() {
  const serverIp = document.getElementById('serverIp').value.trim();
  const streamPath = document.getElementById('streamPath').value.trim();
  
  if (!serverIp || !streamPath) {
    setStatus('âŒ Please enter both Server IP and Stream Path', 'error');
    return;
  }
  
  // Save for next time
  saveConfig();
  
  const WHEP_ENDPOINT = `http://${serverIp}:${CONFIG.MEDIAMTX_PORT}/${streamPath}/whep`;
  
  try {
    setStatus('â³ Connecting to ' + serverIp + '...', 'info');
    
    // Close previous connection
    if (pc) {
      pc.close();
    }
    
    // Create new peer connection
    pc = new RTCPeerConnection({
      iceServers: [{ urls: [CONFIG.STUN_SERVER] }]
    });
    
    const video = document.getElementById('video');
    
    // Add video transceiver
    pc.addTransceiver('video', { direction: 'recvonly' });
    
    // Handle incoming video track
    pc.ontrack = (event) => {
      console.log('ðŸ“¹ Track received:', event.track.kind);
      video.srcObject = event.streams[0];
      setStatus('ðŸŸ¢ Connected - Streaming', 'success');
    };
    
    // Handle connection state changes
    pc.onconnectionstatechange = () => {
      console.log('Connection state:', pc.connectionState);
      switch (pc.connectionState) {
        case 'failed':
        case 'disconnected':
          setStatus('ðŸ”´ Connection lost', 'error');
          break;
        case 'closed':
          setStatus('Connection closed', 'warning');
          break;
      }
    };
    
    // Handle ICE candidates
    pc.onicecandidate = (event) => {
      if (event.candidate) {
        console.log('ðŸ§Š ICE candidate:', event.candidate.candidate);
      }
    };

    // Create and send offer
    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    
    console.log('ðŸ“¤ Sending offer to', WHEP_ENDPOINT);
    
    const res = await fetch(WHEP_ENDPOINT, {
      method: 'POST',
      headers: { 'Content-Type': 'application/sdp' },
      body: offer.sdp
    });

    if (!res.ok) {
      const errorText = await res.text();
      console.error('Server error:', errorText);
      throw new Error(`Server error: ${res.status} - ${errorText}`);
    }

    // Receive and set answer
    const answerSdp = await res.text();
    console.log('ðŸ“¥ Received answer');
    
    const answer = new RTCSessionDescription({
      type: 'answer',
      sdp: answerSdp
    });
    
    await pc.setRemoteDescription(answer);
    console.log('âœ… WebRTC connection established');
    
  } catch (error) {
    console.error('âŒ Error:', error);
    setStatus('âŒ Error: ' + error.message, 'error');
  }
}

// Load saved config on page load
window.addEventListener('load', loadConfig);

// Allow Enter key to start stream
document.addEventListener('keypress', (e) => {
  if (e.key === 'Enter') {
    startStream();
  }
});
</script>
</body>
</html>
